import React, { useState, useCallback, useEffect } from 'react';
import {
  Page,
  Layout,
  Card,
  Button,
  TextField,
  Select,
  FormLayout,
  DropZone,
  Stack,
  Thumbnail,
  Caption,
  Banner,
  TextContainer,
  DataTable,
  Badge,
  ButtonGroup,
  Modal,
} from '@shopify/polaris';
import axios from 'axios';

const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3000';

const Admin = () => {
  const [sections, setSections] = useState([]);
  const [showForm, setShowForm] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    category: '',
    price: '',
    premium: false,
    files: [],
  });
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(null);
  const [deleteModal, setDeleteModal] = useState({ active: false, sectionId: null });

  useEffect(() => {
    fetchSections();
  }, []);

  const fetchSections = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/sections`);
      setSections(response.data);
    } catch (error) {
      setError('Failed to load sections');
    }
  };

  const handleInputChange = useCallback((field) => (value) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  }, []);

  const handleFileDrop = useCallback(
    (_droppedFiles, acceptedFiles, _rejectedFiles) => {
      setFormData((prev) => ({
        ...prev,
        files: [...prev.files, ...acceptedFiles],
      }));
    },
    []
  );

  const handleSubmit = async () => {
    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('description', formData.description);
      data.append('category', formData.category);
      data.append('price', formData.price);
      data.append('premium', formData.premium);
      formData.files.forEach((file) => {
        data.append('files', file);
      });

      if (editingId) {
        await axios.put(`${API_URL}/api/sections/${editingId}`, data);
        setSuccess('Section updated successfully');
      } else {
        await axios.post(`${API_URL}/api/sections`, data);
        setSuccess('Section created successfully');
      }

      resetForm();
      fetchSections();
    } catch (error) {
      setError('Failed to save section');
    }
  };

  const handleEdit = (section) => {
    setEditingId(section.id);
    setFormData({
      name: section.name,
      description: section.description,
      category: section.category,
      price: section.price.toString(),
      premium: section.premium,
      files: [],
    });
    setShowForm(true);
  };

  const handleDelete = async (id) => {
    try {
      await axios.delete(`${API_URL}/api/sections/${id}`);
      setSuccess('Section deleted successfully');
      fetchSections();
      setDeleteModal({ active: false, sectionId: null });
    } catch (error) {
      setError('Failed to delete section');
    }
  };

  const resetForm = () => {
    setFormData({
      name: '',
      description: '',
      category: '',
      price: '',
      premium: false,
      files: [],
    });
    setEditingId(null);
    setShowForm(false);
  };

  const rows = sections.map((section) => [
    section.name,
    section.category,
    `$${section.price}`,
    section.premium ? <Badge status="info">Premium</Badge> : 'Free',
    <ButtonGroup>
      <Button onClick={() => handleEdit(section)}>Edit</Button>
      <Button
        destructive
        onClick={() => setDeleteModal({ active: true, sectionId: section.id })}
      >
        Delete
      </Button>
    </ButtonGroup>,
  ]);

  return (
    <Page
      title="Sections Gallery Admin"
      primaryAction={{
        content: 'Add New Section',
        onAction: () => setShowForm(true),
      }}
    >
      <Layout>
        {error && (
          <Layout.Section>
            <Banner status="critical" onDismiss={() => setError(null)}>
              {error}
            </Banner>
          </Layout.Section>
        )}

        {success && (
          <Layout.Section>
            <Banner status="success" onDismiss={() => setSuccess(null)}>
              {success}
            </Banner>
          </Layout.Section>
        )}

        {showForm && (
          <Layout.Section>
            <Card title={editingId ? 'Edit Section' : 'Add New Section'}>
              <FormLayout>
                <TextField
                  label="Name"
                  value={formData.name}
                  onChange={handleInputChange('name')}
                  autoComplete="off"
                />

                <TextField
                  label="Description"
                  value={formData.description}
                  onChange={handleInputChange('description')}
                  multiline={4}
                  autoComplete="off"
                />

                <Select
                  label="Category"
                  options={[
                    { label: 'Hero', value: 'hero' },
                    { label: 'Features', value: 'features' },
                    { label: 'Testimonials', value: 'testimonials' },
                    { label: 'Gallery', value: 'gallery' },
                    { label: 'Contact', value: 'contact' },
                  ]}
                  value={formData.category}
                  onChange={handleInputChange('category')}
                />

                <TextField
                  label="Price"
                  type="number"
                  value={formData.price}
                  onChange={handleInputChange('price')}
                  prefix="$"
                  autoComplete="off"
                />

                <DropZone
                  allowMultiple
                  onDrop={handleFileDrop}
                >
                  <DropZone.FileUpload />
                </DropZone>

                {formData.files.length > 0 && (
                  <Stack vertical>
                    {formData.files.map((file, index) => (
                      <Stack aligment="center" key={index}>
                        <Thumbnail
                          size="small"
                          alt={file.name}
                          source={URL.createObjectURL(file)}
                        />
                        <Caption>{file.name}</Caption>
                      </Stack>
                    ))}
                  </Stack>
                )}

                <ButtonGroup>
                  <Button primary onClick={handleSubmit}>
                    {editingId ? 'Update' : 'Create'}
                  </Button>
                  <Button onClick={resetForm}>Cancel</Button>
                </ButtonGroup>
              </FormLayout>
            </Card>
          </Layout.Section>
        )}

        <Layout.Section>
          <Card>
            <DataTable
              columnContentTypes={['text', 'text', 'numeric', 'text', 'numeric']}
              headings={['Name', 'Category', 'Price', 'Type', 'Actions']}
              rows={rows}
            />
          </Card>
        </Layout.Section>
      </Layout>

      <Modal
        open={deleteModal.active}
        onClose={() => setDeleteModal({ active: false, sectionId: null })}
        title="Delete Section"
        primaryAction={{
          content: 'Delete',
          destructive: true,
          onAction: () => handleDelete(deleteModal.sectionId),
        }}
        secondaryActions={[
          {
            content: 'Cancel',
            onAction: () => setDeleteModal({ active: false, sectionId: null }),
          },
        ]}
      >
        <Modal.Section>
          <TextContainer>
            Are you sure you want to delete this section? This action cannot be
            undone.
          </TextContainer>
        </Modal.Section>
      </Modal>
    </Page>
  );
};

export default Admin;
